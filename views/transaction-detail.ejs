<!DOCTYPE html>
<html lang="fr">
<head>
    <%- include('partials/head', { title: 'Transaction Details - Tah Prod' }) %>
</head>
<body>
    <%- include('partials/navbar') %>

    <main class="main-content">
        <div class="form-container transaction-detail-container">
            <h1 class="form-title">Transaction Details</h1>
            <%- include('partials/messages') %>

            <%
            // Compute permissions based on role
            const canEdit = isAdmin || transaction.status === 'pending';
            const canDelete = isAdmin || transaction.status === 'pending';
            %>

            <!-- Transaction ID (Read-only) -->
            <div class="info-box">
                <p><strong>Transaction ID:</strong> <%= transaction.id %></p>
                <p><strong>Band:</strong> <%= transaction.band_name %></p>
                <p><strong>Status:</strong>
                    <% if (transaction.status === 'pending') { %>
                        <span class="status-badge status-badge-pending">PENDING</span>
                    <% } else { %>
                        <span class="status-badge status-badge-validated">VALIDATED</span>
                    <% } %>
                </p>
                <% if (transaction.transaction_date) { %>
                    <p><strong>Transaction Date:</strong> <%= new Date(transaction.transaction_date).toLocaleDateString() %></p>
                <% } %>
                <p><strong>Created:</strong> <%= new Date(transaction.created_at).toLocaleDateString() %></p>
            </div>

            <!-- Edit Transaction Form -->
            <% if (canEdit) { %>
                <div class="info-box">
                    <h2 class="section-title">Edit Transaction</h2>
                    <%- include('partials/transaction-form', {
                        formAction: urlPrefix + '/' + transaction.id + '/edit',
                        transaction: transaction,
                        categories: categories,
                        canEditStatus: isAdmin
                    }) %>
                </div>
            <% } else { %>
                <div class="info-box">
                    <h2 class="section-title">Transaction Details</h2>
                    <p><strong>Type:</strong> <%= transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1) %></p>
                    <p><strong>Category:</strong> <%= transaction.category_name %></p>
                    <p><strong>Amount:</strong> <%= transaction.type === 'expense' ? '-' : '' %><%= transaction.amount.toFixed(2) %> â‚¬</p>
                    <p><strong>Description:</strong></p>
                    <p class="preformatted-text"><%= transaction.description %></p>
                </div>
            <% } %>

            <!-- Qonto Transaction Linker (Admin Only) -->
            <%- include('partials/qonto-linker', {
                isAdmin: isAdmin,
                transaction: transaction,
                linkedQontoTransactions: linkedQontoTransactions || [],
                band: band
            }) %>

            <!-- Document Management -->
            <div class="info-box">
                <h2 class="section-title">Documents</h2>

                <% if (!transaction.drive_folder_id) { %>
                    <!-- No folder exists -->
                    <p class="section-spacing">No documents folder yet.</p>
                    <form id="create-folder-form" action="<%= urlPrefix %>/<%= transaction.id %>/create-folder" method="POST">
                        <button type="submit" class="btn" id="create-folder-btn">Create Documents Folder</button>
                    </form>
                <% } else { %>
                    <!-- Folder exists - show documents -->
                    <% if (documents && documents.length > 0) { %>
                        <div class="table-wrapper section-spacing-large">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Filename</th>
                                        <th>Uploaded</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% documents.forEach(doc => { %>
                                        <tr>
                                            <td>
                                                <a href="https://drive.google.com/file/d/<%= doc.drive_file_id %>/view" target="_blank">
                                                    <%= doc.filename %>
                                                </a>
                                            </td>
                                            <td><%= new Date(doc.uploaded_at).toLocaleDateString() %></td>
                                            <td>
                                                <form action="<%= urlPrefix %>/<%= transaction.id %>/documents/<%= doc.id %>/delete" method="POST" class="inline-form">
                                                    <button type="submit" class="btn btn-small" onclick="return confirm('Delete this document?')">Delete</button>
                                                </form>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <p class="section-spacing">No documents uploaded yet.</p>
                    <% } %>

                    <!-- Upload form -->
                    <h3 class="section-title small-section-title">Upload Documents</h3>
                    <form id="upload-form" action="<%= urlPrefix %>/<%= transaction.id %>/documents" method="POST" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="documents" class="form-label">Select files</label>
                            <input
                                type="file"
                                id="documents"
                                name="documents"
                                class="form-input"
                                multiple
                                accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx"
                                required
                            >
                        </div>
                        <button type="submit" class="btn" id="upload-btn">Upload Documents</button>
                    </form>

                    <!-- Link to folder -->
                    <div class="section-top-border">
                        <a href="https://drive.google.com/drive/folders/<%= transaction.drive_folder_id %>" target="_blank" class="btn btn-small">
                            View Folder in Google Drive
                        </a>
                    </div>
                <% } %>
            </div>

            <!-- Delete Transaction -->
            <% if (canDelete) { %>
                <div class="info-box">
                    <h2 class="section-title">Delete Transaction</h2>
                    <form action="<%= urlPrefix %>/<%= transaction.id %>/delete" method="POST">
                        <button type="submit" class="btn" onclick="return confirm('<%= transaction.status === 'validated' ? 'This transaction is validated. Really delete?' : 'Delete this transaction?' %>')">
                            Delete Transaction
                        </button>
                    </form>
                </div>
            <% } %>

            <div class="mt-2">
                <a href="<%= backUrl %>" class="btn">Back to All Transactions</a>
            </div>
        </div>
    </main>

    <%- include('partials/footer') %>

    <script src="/js/transaction-detail.js"></script>
</body>
</html>
