<% if (transactions && transactions.length > 0) { %>
    <table class="data-table">
        <thead>
            <tr>
                <% if (showBandColumn) { %>
                    <th>Band</th>
                <% } %>
                <th>Type</th>
                <th>Category</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <% transactions.forEach(transaction => { %>
                <tr>
                    <% if (showBandColumn) { %>
                        <td><%= transaction.band_name %></td>
                    <% } %>
                    <td>
                        <%= transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1) %>
                    </td>
                    <td><%= transaction.category_name || 'N/A' %></td>
                    <td>
                        <% const maxLength = 50; %>
                        <% if (transaction.description.length > maxLength) { %>
                            <%= transaction.description.substring(0, maxLength) %>...
                        <% } else { %>
                            <%= transaction.description %>
                        <% } %>
                    </td>
                    <td>â‚¬<%= transaction.amount.toFixed(2) %></td>
                    <td>
                        <% if (transaction.status === 'pending') { %>
                            <span style="background-color: #ffeb3b; color: #000; padding: 0.25rem 0.5rem; border: 1px solid #000;">PENDING</span>
                        <% } else { %>
                            <span style="background-color: #4caf50; color: #fff; padding: 0.25rem 0.5rem; border: 1px solid #000;">VALIDATED</span>
                        <% } %>
                    </td>
                    <td>
                        <% if (transaction.transaction_date) { %>
                            <%= new Date(transaction.transaction_date).toLocaleDateString() %>
                        <% } else { %>
                            -
                        <% } %>
                    </td>
                    <td>
                        <% if (canEdit(transaction)) { %>
                            <a href="<%= editUrlPrefix %>/<%= transaction.id %>/edit" class="btn btn-small" style="margin-right: 0.5rem;">Edit</a>
                        <% } %>

                        <% if (canValidate && transaction.status === 'pending') { %>
                            <form action="<%= validateUrlPrefix %>/<%= transaction.id %>/validate" method="POST" style="display: inline;" onsubmit="return validateTransaction(event, this)">
                                <button type="submit" class="btn btn-small" style="margin-right: 0.5rem;">Validate</button>
                            </form>
                        <% } %>

                        <% if (transaction.drive_folder_id) { %>
                            <a href="https://drive.google.com/drive/folders/<%= transaction.drive_folder_id %>" target="_blank" class="btn btn-small" style="margin-right: 0.5rem;">Documents</a>
                        <% } %>

                        <% if (canDelete(transaction)) { %>
                            <form action="<%= deleteUrlPrefix %>/<%= transaction.id %>/delete" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-small" onclick="return confirm('<%= transaction.status === 'validated' ? 'This transaction is validated. Really delete?' : 'Delete this transaction?' %>')">Delete</button>
                            </form>
                        <% } %>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
<% } else { %>
    <p style="text-align: center; padding: 2rem;">No transactions yet.</p>
<% } %>

<% if (canValidate) { %>
<script>
function validateTransaction(event, form) {
    event.preventDefault();

    const dateInput = prompt('Enter transaction date (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);

    if (!dateInput) {
        return false;
    }

    // Validate date format
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(dateInput)) {
        alert('Invalid date format. Please use YYYY-MM-DD');
        return false;
    }

    // Check if date is not in future
    const selectedDate = new Date(dateInput);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (selectedDate > today) {
        alert('Transaction date cannot be in the future');
        return false;
    }

    // Add hidden input with date
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'transaction_date';
    hiddenInput.value = dateInput;
    form.appendChild(hiddenInput);

    form.submit();
    return true;
}
</script>
<% } %>
